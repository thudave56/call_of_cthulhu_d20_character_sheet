<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Call of Cthulhu d20 Character Sheet</title>
    <!-- Link the stylesheet -->
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <h1>Call of Cthulhu d20 Character Sheet</h1>
      <p class="subtitle">
        Build and manage your investigator characters for the d20 adaptation of
        <em>Call of Cthulhu</em>. Ability modifiers, saving throws, attack
        bonuses and sanity values are calculated automatically. Save your
        creations locally and reload them any time.
      </p>
      <div class="mode-toggle">
        <button id="creationModeBtn" class="mode-btn active">📋 Creation Mode</button>
        <button id="gameplayModeBtn" class="mode-btn">🎲 Gameplay Mode</button>
      </div>
    </header>

    <!-- Game Session Panel (Gameplay Mode Only) -->
    <section class="section gameplay-only" id="game-session-panel">
      <h2>🎲 Game Session</h2>
      <div class="session-grid">
        <div class="vitals-group">
          <h3>Hit Points</h3>
          <div class="vital-display">
            <div class="vital-numbers">
              <span class="vital-current" id="displayCurrentHP">0</span>
              <span class="vital-separator">/</span>
              <span class="vital-max" id="displayMaxHP">0</span>
            </div>
            <div class="vital-bar-container">
              <div class="vital-bar" id="hpBar"></div>
            </div>
            <div class="vital-percentage" id="hpPercentage">100%</div>
          </div>
          <div class="quick-modify">
            <label>Take Damage:</label>
            <input type="number" id="damageAmount" min="0" value="0" />
            <button id="applyDamageBtn" class="quick-btn">Apply</button>
            <button id="healBtn" class="quick-btn heal">Heal</button>
          </div>
        </div>

        <div class="vitals-group">
          <h3>Sanity</h3>
          <div class="vital-display">
            <div class="vital-numbers">
              <span class="vital-current" id="displayCurrentSanity">0</span>
              <span class="vital-separator">/</span>
              <span class="vital-max" id="displayMaxSanity">0</span>
            </div>
            <div class="vital-bar-container">
              <div class="vital-bar sanity" id="sanityBar"></div>
            </div>
            <div class="vital-percentage" id="sanityPercentage">100%</div>
          </div>
          <div class="sanity-threshold" id="sanityThresholdDisplay">
            20% Threshold: <span id="displaySanity20">0</span>
          </div>
          <div class="quick-modify">
            <label>Sanity Loss:</label>
            <input type="number" id="sanityLossAmount" min="0" value="0" />
            <button id="applySanityLossBtn" class="quick-btn">Apply</button>
            <button id="restoreSanityBtn" class="quick-btn heal">Restore</button>
          </div>
        </div>

        <div class="combat-stats-group">
          <h3>Combat Stats</h3>
          <div class="stat-line">
            <span class="stat-label">Base Attack:</span>
            <span class="stat-value" id="displayBaseAttack">+0</span>
          </div>
          <div class="stat-line">
            <span class="stat-label">Attack (Melee):</span>
            <span class="stat-value" id="displayMeleeAttack">+0</span>
            <span class="stat-detail">(BAB + STR)</span>
          </div>
          <div class="stat-line">
            <span class="stat-label">Attack (Ranged):</span>
            <span class="stat-value" id="displayRangedAttack">+0</span>
            <span class="stat-detail">(BAB + DEX)</span>
          </div>
          <div class="saves-display">
            <div class="save-item">
              <span class="save-label">Fort:</span>
              <span class="save-value" id="displayFortSave">+0</span>
            </div>
            <div class="save-item">
              <span class="save-label">Ref:</span>
              <span class="save-value" id="displayRefSave">+0</span>
            </div>
            <div class="save-item">
              <span class="save-label">Will:</span>
              <span class="save-value" id="displayWillSave">+0</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Session Notes -->
      <div class="session-notes">
        <h3>Session Notes</h3>
        <textarea id="sessionNotes" placeholder="Track clues, NPCs, important events..."></textarea>
      </div>
    </section>

    <!-- Character Info -->
    <section class="section" id="character-info">
      <h2>Character Information</h2>
      <div class="grid two-col">
        <div class="form-group">
          <label for="charName">Character Name</label>
          <input type="text" id="charName" />
        </div>
        <div class="form-group">
          <label for="playerName">Player Name</label>
          <input type="text" id="playerName" />
        </div>
        <div class="form-group">
          <label for="age">Age</label>
          <input type="number" id="age" min="15" max="120" />
        </div>
        <div class="form-group">
          <label for="ageCategory">Age Category</label>
          <select id="ageCategory">
            <option value="young">Young Adult (15-34)</option>
            <option value="middle">Middle Age (35-52)</option>
            <option value="old">Old (53-69)</option>
            <option value="venerable">Venerable (70+)</option>
          </select>
        </div>
        <div class="form-group">
          <label for="gender">Gender</label>
          <input type="text" id="gender" />
        </div>
        <div class="form-group">
          <label for="profession">Profession</label>
          <select id="profession"></select>
        </div>
        <div class="form-group">
          <label for="level">Level</label>
          <input type="number" id="level" min="1" max="20" value="1" />
        </div>
        <div class="form-group">
          <label for="attackOption">Attack Option</label>
          <select id="attackOption">
            <option value="offense">Offense (higher attack bonus, weaker saves)</option>
            <option value="defense">Defense (stronger saves, lower attack bonus)</option>
          </select>
        </div>
        <div class="form-group" id="goodSavesContainer">
          <label>Good Saves (choose according to option)</label>
          <div class="checkbox-group">
            <label><input type="checkbox" id="goodFort" /> Fortitude</label>
            <label><input type="checkbox" id="goodRef" /> Reflex</label>
            <label><input type="checkbox" id="goodWill" /> Will</label>
          </div>
        </div>
        <div class="form-group">
          <label for="era">Era</label>
          <select id="era">
            <option value="1901-1920">1901–1920</option>
            <option value="1921-1940">1921–1940</option>
            <option value="1941-1960">1941–1960</option>
            <option value="1961-1980">1961–1980</option>
            <option value="1981+">1981+</option>
          </select>
        </div>
      </div>
      <!-- Profession description placeholder -->
      <div id="profession-info" class="profession-info"></div>
    </section>

    <!-- Abilities -->
    <section class="section" id="abilities-section">
      <h2>Ability Scores</h2>
      <div id="ageModifiersNote" class="age-modifiers-note"></div>
      <div class="ability-reroll-section">
        <button type="button" id="checkRerollBtn" class="reroll-btn">Check if Reroll Needed</button>
        <button type="button" id="rerollAllBtn" class="reroll-btn">Reroll All Abilities (4d6 drop lowest)</button>
        <div id="rerollMessage" class="reroll-message"></div>
      </div>
      <table class="abilities-table">
        <thead>
          <tr>
            <th>Ability</th>
            <th>Score</th>
            <th>Modifier</th>
          </tr>
        </thead>
        <tbody id="abilitiesBody">
          <!-- Will be populated via script -->
        </tbody>
      </table>
    </section>

    <!-- Derived Statistics -->
    <section class="section" id="derived-section">
      <h2>Derived Statistics</h2>
      <div class="grid three-col">
        <div class="derived-group">
          <h3>Base Attack Bonus</h3>
          <p id="baseAttack"></p>
        </div>
        <div class="derived-group">
          <h3>Saving Throws</h3>
          <p>Fortitude: <span id="fortSave"></span></p>
          <p>Reflex: <span id="refSave"></span></p>
          <p>Will: <span id="willSave"></span></p>
        </div>
        <div class="derived-group">
          <h3>Hit Points</h3>
          <p class="hp-calculation" id="hpCalculation"></p>
          <div class="form-group small">
            <label for="hitPoints">Max HP</label>
            <input type="number" id="hitPoints" min="0" value="6" />
            <button type="button" id="autoCalcHPBtn" class="auto-calc-btn">Auto-Calculate</button>
          </div>
          <div class="form-group small">
            <label for="currentHP">Current HP</label>
            <input type="number" id="currentHP" min="0" />
          </div>
          <p class="hp-bonus" id="hpBonusNote"></p>
        </div>
        <div class="derived-group">
          <h3>Sanity</h3>
          <p>Starting: <span id="sanityStarting"></span></p>
          <p>Maximum: <span id="sanityMax"></span></p>
          <p>20% Threshold: <span id="sanity20"></span></p>
          <div class="form-group small">
            <label for="currentSanity">Current Sanity</label>
            <input type="number" id="currentSanity" min="0" />
          </div>
          <div class="insanity-tracker">
            <label>Insanity State:</label>
            <select id="insanityState">
              <option value="sane">Sane</option>
              <option value="temporary">Temporary Insanity</option>
              <option value="indefinite">Indefinite Insanity</option>
              <option value="permanent">Permanent Insanity</option>
            </select>
            <p class="insanity-note" id="insanityNote"></p>
          </div>
        </div>
        <div class="derived-group">
          <h3>Money</h3>
          <p>Starting Funds: <span id="startingMoney"></span></p>
          <div class="form-group small">
            <label for="currentMoney">Current Money</label>
            <input type="number" id="currentMoney" min="0" />
          </div>
        </div>
      </div>
    </section>

    <!-- Feats -->
    <section class="section" id="feats-section">
      <h2>Feats</h2>
      <p>Select any feats your character possesses. Some feats apply
        automatic bonuses to saves or hit points.</p>
      <div class="feat-counter" id="featCounter">
        <span class="feat-counter-label">Feats Selected:</span>
        <span class="feat-counter-current" id="featCounterCurrent">0</span>
        <span class="feat-counter-separator">/</span>
        <span class="feat-counter-total" id="featCounterTotal">1</span>
        <span class="feat-counter-note" id="featCounterNote">(1 at 1st level)</span>
      </div>
      <div class="checkbox-group" id="featsContainer">
        <!-- Feat checkboxes populated by script -->
      </div>

      <!-- Selected Feats Summary -->
      <div id="selectedFeatsSummary" class="selected-feats-summary">
        <h3>Selected Feats & Benefits</h3>
        <div id="selectedFeatsList" class="selected-feats-list">
          <p class="no-feats-message">No feats selected yet. Select feats above to see their benefits here.</p>
        </div>
      </div>
    </section>

    <!-- Skills -->
    <section class="section" id="skills-section">
      <h2>Skills</h2>
      <p>Enter your ranks in each skill. The total column includes your
        ranks plus the relevant ability modifier and any miscellaneous
        bonuses. Profession skills are highlighted.</p>
      <div class="skill-points-tracker" id="skillPointsTracker">
        <span class="skill-points-label">Skill Points:</span>
        <span class="skill-points-used" id="skillPointsUsed">0</span>
        <span class="skill-points-separator">/</span>
        <span class="skill-points-total" id="skillPointsTotal">0</span>
        <span class="skill-points-remaining" id="skillPointsRemaining">(0 remaining)</span>
      </div>
      <div class="skills-controls">
        <input type="text" id="skillSearch" placeholder="🔍 Search skills..." />
        <button id="showProfessionSkillsBtn" class="filter-btn">Show Profession Skills Only</button>
        <button id="showAllSkillsBtn" class="filter-btn active">Show All Skills</button>
      </div>
      <table class="skills-table">
        <thead>
          <tr>
            <th>Skill</th>
            <th>Ability</th>
            <th>Core Skill</th>
            <th>Ranks</th>
            <th>Misc</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody id="skillsBody">
          <!-- Populated via script -->
        </tbody>
      </table>
    </section>

    <!-- Save/Load Buttons -->
    <section class="section" id="storage-section">
      <h2>Manage Characters</h2>
      <div class="button-group">
        <button id="saveButton">Save Character</button>
        <button id="loadButton">Load Character</button>
        <button id="deleteButton">Delete Character</button>
      </div>
      <div class="form-group">
        <label for="characterSelect">Saved Characters</label>
        <select id="characterSelect"></select>
      </div>
    </section>

    <footer>
      <p>
        This sheet is built according to the
        <em>Call of Cthulhu d20</em> ruleset. Sanity values are calculated
        using the rules that starting Sanity equals five times Wisdom and
        maximum Sanity equals 99 minus Cthulhu Mythos skill ranks【567432723370824†L3170-L3239】.
        Good and bad save progressions and attack bonus progressions follow
        the tables from the GM screen【878580011413210†L107-L120】. Profession
        templates and starting money modifiers are taken from the same
        reference【878580011413210†L130-L209】.
      </p>
    </footer>

    <!-- Link the script -->
    <script src="script.js"></script>
  </body>
</html>
